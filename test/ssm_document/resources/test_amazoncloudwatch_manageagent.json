{
  "schemaVersion": "2.2",
  "description": "Send commands to Amazon CloudWatch Agent",
  "parameters": {
    "action": {
      "description": "The action CloudWatch Agent should take.",
      "type": "String",
      "default": "configure",
      "allowedValues": [
        "configure",
        "configure (append)",
        "configure (remove)",
        "start",
        "status",
        "status-with-workloads",
        "stop"
      ],
      "interpolationType": "ENV_VAR"
    },
    "mode": {
      "description": "Controls platform-specific default behavior such as whether to include EC2 Metadata in metrics.",
      "type": "String",
      "default": "ec2",
      "allowedValues": [
        "ec2",
        "onPremise",
        "auto"
      ],
      "interpolationType": "ENV_VAR"
    },
    "optionalConfigurationSource": {
      "description": "Only for 'configure' related actions. Use 'ssm' to apply a ssm parameter as config. Use 'default' to apply default config for amazon-cloudwatch-agent. Use 'all' with 'configure (remove)' to clean all configs for amazon-cloudwatch-agent.",
      "type": "String",
      "allowedValues": [
        "ssm",
        "default",
        "all"
      ],
      "default": "ssm",
      "interpolationType": "ENV_VAR"
    },
    "optionalConfigurationLocation": {
      "description": "For configure actions when optionalConfigurationSource is ssm: Single SSM parameter name, or comma-separated list of SSM parameter names to merge multiple configurations.",
      "type": "String",
      "default": "",
      "allowedPattern": "^[a-zA-Z0-9-\"~:_@./^(*)!<>?=+,]*$",
      "interpolationType": "ENV_VAR"
    },
    "optionalRestart": {
      "description": "Only for 'configure' related actions. If 'yes', restarts the agent to use the new configuration. Otherwise the new config will only apply on the next agent restart.",
      "type": "String",
      "default": "yes",
      "allowedValues": [
        "yes",
        "no"
      ],
      "interpolationType": "ENV_VAR"
    }
  },
  "mainSteps": [
    {
      "name": "ControlCloudWatchAgentWindows",
      "action": "aws:runPowerShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          " if (-not (Test-Path env:SSM_action)) { $env:SSM_action = \"{{action}}\" }",
          " if (-not (Test-Path env:SSM_mode)) { $env:SSM_mode = \"{{mode}}\" }",
          " if (-not (Test-Path env:SSM_optionalConfigurationSource)) { $env:SSM_optionalConfigurationSource = \"{{optionalConfigurationSource}}\" }",
          " if (-not (Test-Path env:SSM_optionalConfigurationLocation)) { $env:SSM_optionalConfigurationLocation = \"{{optionalConfigurationLocation}}\" }",
          " if (-not (Test-Path env:SSM_optionalRestart)) { $env:SSM_optionalRestart = \"{{optionalRestart}}\" }",
          " Set-StrictMode -Version 2.0",
          " $ErrorActionPreference = 'Stop'",
          " $Cmd = \"${Env:ProgramFiles}\\Amazon\\AmazonCloudWatchAgent\\amazon-cloudwatch-agent-ctl.ps1\"",
          " if (!(Test-Path -LiteralPath \"${Cmd}\")) {",
          "     Write-Output 'CloudWatch Agent not installed.  Please install it using the AWS-ConfigureAWSPackage SSM Document.'",
          "     exit 1",
          " }",
          " $Params = @()",
          " $Action = $env:SSM_action",
          " # Handle multi-config merge for configure action",
          " $ConfigLocation = $env:SSM_optionalConfigurationLocation",
          " if ($Action -eq 'configure' -and $env:SSM_optionalConfigurationSource -eq 'ssm' -and $ConfigLocation -match ',') {",
          "     Write-Output \"Merging multiple configurations: $ConfigLocation\"",
          "     $Configs = $ConfigLocation -split ','",
          "     $First = $true",
          "     foreach ($Config in $Configs) {",
          "         if ($First) {",
          "             $Action = 'fetch-config'",
          "             Write-Output \"Fetching base config: $Config\"",
          "             $First = $false",
          "         } else {",
          "             $Action = 'append-config'",
          "             Write-Output \"Appending config: $Config\"",
          "         }",
          "         & \"$Cmd\" -a $Action -m $env:SSM_mode -c \"ssm:$Config\"",
          "     }",
          "     if ($env:SSM_optionalRestart -eq 'yes') {",
          "         Write-Output \"Restarting CloudWatch Agent...\"",
          "         & \"$Cmd\" -a stop",
          "         & \"$Cmd\" -a start",
          "     }",
          "     Write-Output \"Successfully merged all configurations\"",
          "     exit 0",
          " }",
          " # Map action names to agent commands",
          " if ($Action -eq 'configure') {",
          "     $Action = 'fetch-config'",
          " } elseif ($Action -eq 'configure (append)') {",
          "     $Action = 'append-config'",
          " } elseif ($Action -eq 'configure (remove)') {",
          "     $Action = 'remove-config'",
          " }",
          " if ($Action -eq 'fetch-config' -Or $Action -eq 'append-config' -Or $Action -eq 'remove-config') {",
          "     $CWAConfig = $env:SSM_optionalConfigurationLocation",
          "     if ($env:SSM_optionalConfigurationSource -eq 'ssm') {",
          "         if ($CWAConfig) {",
          "             $CWAConfig = \"ssm:${CWAConfig}\"",
          "         }",
          "     } else {",
          "         $CWAConfig = $env:SSM_optionalConfigurationSource",
          "     }",
          "     if (!$CWAConfig) {",
          "         Write-Output 'AmazonCloudWatchAgent config should be specified'",
          "         exit 1",
          "     }",
          "     if ($CWAConfig -eq 'all' -And $Action -ne 'remove-config') {",
          "         Write-Output 'Configuration location \"all\" can only be applied with action \"remove-config\"'",
          "         exit 1",
          "     }",
          "     $Params += ('-c', \"${CWAConfig}\")",
          "     if ($env:SSM_optionalRestart -eq 'yes') {",
          "         $Params += '-s'",
          "     }",
          " }",
          " $Params += ('-a', \"${Action}\", '-m', $env:SSM_mode)",
          " if ($Action -eq 'status-with-workloads') {",
          "     $Output = Invoke-Expression \"& '${Cmd}' ${Params}\"",
          "     if ($LASTEXITCODE -ne 0) {",
          "         $global:LASTEXITCODE = 0",
          "         $Params = $Params -replace 'status-with-workloads', 'status'",
          "         Invoke-Expression \"& '${Cmd}' ${Params}\"",
          "     } else {",
          "         Write-Output $Output",
          "     }",
          " } else {",
          "     Invoke-Expression \"& '${Cmd}' ${Params}\"",
          " }",
          " Set-StrictMode -Off",
          " exit $LASTEXITCODE"
        ]
      }
    },
    {
      "name": "ControlCloudWatchAgentLinux",
      "action": "aws:runShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "inputs": {
        "runCommand": [
          " #!/bin/sh",
          " if [[ -z \"${SSM_action}\" ]]; then export SSM_action=\"{{action}}\"; fi",
          " if [[ -z \"${SSM_mode}\" ]]; then export SSM_mode=\"{{mode}}\"; fi",
          " if [[ -z \"${SSM_optionalConfigurationSource}\" ]]; then export SSM_optionalConfigurationSource=\"{{optionalConfigurationSource}}\"; fi",
          " if [[ -z \"${SSM_optionalConfigurationLocation}\" ]]; then export SSM_optionalConfigurationLocation=\"{{optionalConfigurationLocation}}\"; fi",
          " if [[ -z \"${SSM_optionalRestart}\" ]]; then export SSM_optionalRestart=\"{{optionalRestart}}\"; fi",
          " set -e",
          " set -u",
          " cmd='/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl'",
          " if [ ! -x \"${cmd}\" ]; then",
          "     echo 'CloudWatch Agent not installed.  Please install it using the AWS-ConfigureAWSPackage SSM Document.'",
          " exit 1",
          " fi",
          " action=\"$SSM_action\"",
          " # Handle multi-config merge for configure action",
          " configlocation=\"$SSM_optionalConfigurationLocation\"",
          " if [ \"${action}\" = \"configure\" ] && [ \"$SSM_optionalConfigurationSource\" = \"ssm\" ] && echo \"${configlocation}\" | grep -q \",\"; then",
          "     echo \"Merging multiple configurations: ${configlocation}\"",
          "     first=true",
          "     for config in $(echo \"${configlocation}\" | tr \",\" \" \"); do",
          "         if [ \"${first}\" = \"true\" ]; then",
          "             action=\"fetch-config\"",
          "             echo \"Fetching base config: ${config}\"",
          "             first=false",
          "         else",
          "             action=\"append-config\"",
          "             echo \"Appending config: ${config}\"",
          "         fi",
          "         ${cmd} -a ${action} -m $SSM_mode -c ssm:${config}",
          "     done",
          "     if [ \"$SSM_optionalRestart\" = \"yes\" ]; then",
          "         echo \"Restarting CloudWatch Agent...\"",
          "         ${cmd} -a stop -m $SSM_mode",
          "         ${cmd} -a start -m $SSM_mode",
          "     fi",
          "     echo \"Successfully merged all configurations\"",
          "     exit 0",
          " fi",
          " # Map action names to agent commands",
          " if [ \"${action}\" = 'configure' ]; then",
          "     action='fetch-config'",
          " elif [ \"${action}\" = 'configure (append)' ]; then",
          "     action='append-config'",
          " elif [ \"${action}\" = 'configure (remove)' ]; then",
          "     action='remove-config'",
          " fi",
          " if [ \"${action}\" = 'fetch-config' ] || [ \"${action}\" = 'append-config' ] || [ \"${action}\" = 'remove-config' ]; then",
          "     cwaconfig=\"$SSM_optionalConfigurationLocation\"",
          "     if [ \"$SSM_optionalConfigurationSource\" = 'ssm' ]; then",
          "         if [ -n \"${cwaconfig}\" ]; then",
          "             cwaconfig=\"ssm:${cwaconfig}\"",
          "         fi",
          "     else",
          "         cwaconfig=\"$SSM_optionalConfigurationSource\"",
          "     fi",
          "     if [ -z \"${cwaconfig}\" ]; then",
          "         echo 'AmazonCloudWatchAgent config should be specified'",
          "         exit 1",
          "     fi",
          "     cmd=\"${cmd} -c ${cwaconfig}\"",
          "     if [ \"${cwaconfig}\" = 'all' ] && [ \"${action}\" != 'remove-config' ]; then",
          "         echo 'Configuration location \"all\" can only be applied with action \"remove-config\"'",
          "         exit 1",
          "     fi",
          "     if [ \"$SSM_optionalRestart\" = 'yes' ]; then",
          "         cmd=\"${cmd} -s\"",
          "     fi",
          " fi",
          " cmd=\"${cmd} -a ${action} -m $SSM_mode\"",
          " if [ \"${action}\" = 'status-with-workloads' ]; then",
          "     if ! output=$(${cmd} 2>&1); then",
          "         cmd=$(echo \"${cmd}\" | sed 's/status-with-workloads/status/')",
          "         ${cmd}",
          "     else",
          "         echo \"${output}\"",
          "     fi",
          " else",
          "     ${cmd}",
          " fi"
        ]
      }
    },
    {
      "name": "ControlCloudWatchAgentMacOS",
      "action": "aws:runShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "MacOS"
        ]
      },
      "inputs": {
        "runCommand": [
          " #!/bin/sh",
          " if [[ -z \"${SSM_action}\" ]]; then export SSM_action=\"{{action}}\"; fi",
          " if [[ -z \"${SSM_mode}\" ]]; then export SSM_mode=\"{{mode}}\"; fi",
          " if [[ -z \"${SSM_optionalConfigurationSource}\" ]]; then export SSM_optionalConfigurationSource=\"{{optionalConfigurationSource}}\"; fi",
          " if [[ -z \"${SSM_optionalConfigurationLocation}\" ]]; then export SSM_optionalConfigurationLocation=\"{{optionalConfigurationLocation}}\"; fi",
          " if [[ -z \"${SSM_optionalRestart}\" ]]; then export SSM_optionalRestart=\"{{optionalRestart}}\"; fi",
          " set -e",
          " set -u",
          " cmd='/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl'",
          " if [ ! -x \"${cmd}\" ]; then",
          "     echo 'CloudWatch Agent not installed.  Please install it using the AWS-ConfigureAWSPackage SSM Document.'",
          " exit 1",
          " fi",
          " action=\"$SSM_action\"",
          " # Handle multi-config merge for configure action",
          " configlocation=\"$SSM_optionalConfigurationLocation\"",
          " if [ \"${action}\" = \"configure\" ] && [ \"$SSM_optionalConfigurationSource\" = \"ssm\" ] && echo \"${configlocation}\" | grep -q \",\"; then",
          "     echo \"Merging multiple configurations: ${configlocation}\"",
          "     first=true",
          "     for config in $(echo \"${configlocation}\" | tr \",\" \" \"); do",
          "         if [ \"${first}\" = \"true\" ]; then",
          "             action=\"fetch-config\"",
          "             echo \"Fetching base config: ${config}\"",
          "             first=false",
          "         else",
          "             action=\"append-config\"",
          "             echo \"Appending config: ${config}\"",
          "         fi",
          "         ${cmd} -a ${action} -m $SSM_mode -c ssm:${config}",
          "     done",
          "     if [ \"$SSM_optionalRestart\" = \"yes\" ]; then",
          "         echo \"Restarting CloudWatch Agent...\"",
          "         ${cmd} -a stop -m $SSM_mode",
          "         ${cmd} -a start -m $SSM_mode",
          "     fi",
          "     echo \"Successfully merged all configurations\"",
          "     exit 0",
          " fi",
          " # Map action names to agent commands",
          " if [ \"${action}\" = 'configure' ]; then",
          "     action='fetch-config'",
          " elif [ \"${action}\" = 'configure (append)' ]; then",
          "     action='append-config'",
          " elif [ \"${action}\" = 'configure (remove)' ]; then",
          "     action='remove-config'",
          " fi",
          " if [ \"${action}\" = 'fetch-config' ] || [ \"${action}\" = 'append-config' ] || [ \"${action}\" = 'remove-config' ]; then",
          "     cwaconfig=\"$SSM_optionalConfigurationLocation\"",
          "     if [ \"$SSM_optionalConfigurationSource\" = 'ssm' ]; then",
          "         if [ -n \"${cwaconfig}\" ]; then",
          "             cwaconfig=\"ssm:${cwaconfig}\"",
          "         fi",
          "     else",
          "         cwaconfig=\"$SSM_optionalConfigurationSource\"",
          "     fi",
          "     if [ -n \"${cwaconfig}\" ]; then",
          "         cmd=\"${cmd} -c ${cwaconfig}\"",
          "     fi",
          "     if [ \"${cwaconfig}\" = 'all' ] && [ \"${action}\" != 'remove-config' ]; then",
          "         echo 'Configuration location \"all\" can only be applied with action \"remove-config\"'",
          "         exit 1",
          "     fi",
          "     if [ -z \"${cwaconfig}\" ]; then",
          "         echo 'AmazonCloudWatchAgent config should be specified'",
          "         exit 1",
          "     fi",
          "     if [ \"$SSM_optionalRestart\" = 'yes' ]; then",
          "         cmd=\"${cmd} -s\"",
          "     fi",
          " fi",
          " cmd=\"${cmd} -a ${action} -m $SSM_mode\"",
          " if [ \"${action}\" = 'status-with-workloads' ]; then",
          "     if ! output=$(${cmd} 2>&1); then",
          "         cmd=$(echo \"${cmd}\" | sed 's/status-with-workloads/status/')",
          "         ${cmd}",
          "     else",
          "         echo \"${output}\"",
          "     fi",
          " else",
          "     ${cmd}",
          " fi"
        ]
      }
    }
  ]
}
